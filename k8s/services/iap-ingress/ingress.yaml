{% set services = [
  {'host': 'grafana.testa.getsentry.net', 'serviceName': 'grafana'},
  {'host': 'influxdb.testa.getsentry.net', 'serviceName': 'influxdb'},
  {'host': 'locust.testa.getsentry.net', 'serviceName': 'locust'},
  {'host': 'run.testa.getsentry.net', 'serviceName': 'argo-workflows'},
] %}

apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: iap-ingress
  labels:
    service: iap-ingress
  annotations:
    kubernetes.io/ingress.global-static-ip-name: iap-ingress-address
    networking.gke.io/managed-certificates: "{% for service in services %}{{ "cert-%s"|format(service.host|replace('.', '-')) }}{% if not loop.last %}, {% endif %}{% endfor %}"
spec:
  rules:
{% for service in services %}
  - host: {{ service.host }}
    http:
      paths:
      - backend:
          serviceName: {{ service.serviceName }}
          servicePort: 80
{% endfor %}
